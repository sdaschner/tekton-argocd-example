apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: run-systemtest
spec:
  params:
  - name: gateway
  - name: buildRevision
  - name: appGitUrl
  workspaces:
  - name: app-source
  steps:
  - name: git-checkout
    image: alpine/git:v2.26.2
    workingDir: "$(workspaces.app-source.path)"
    script: |
      #!/usr/bin/env sh
      set -e

      eval $(ssh-agent)
      ssh-add ~/.ssh/id_*
      git config --global core.sshCommand 'ssh -o StrictHostKeyChecking=accept-new'

      git init
      git remote add origin $(params.appGitUrl)
      git fetch --depth 1 origin $(params.buildRevision)
      git checkout FETCH_HEAD

  - name: run-mvn-st
    image: sdaschner/maven-jdk14:quarkus-deps-1.5.1-b5
    workingDir: "$(workspaces.app-source.path)/system-test/"
    command:
    - /usr/bin/mvn
    args:
    - verify
    - "-Dapp.test.host=$(inputs.params.gateway)"
    - "-Dapp.test.port=80"
---